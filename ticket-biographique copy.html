<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Auto Biographical Ticket</title>
<style>
body{margin:0;font-family:Courier, monospace;background:#f7fafc;padding:20px;}
.wrap{display:grid;grid-template-columns:1fr 1fr;gap:20px;max-width:1100px;margin:auto;}
.card{background:#fff;padding:18px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.06);}
h1{margin:0 0 8px;font-size:18px;}
label{display:block;margin-bottom:10px;font-size:13px;color:#6b7280;}
input{width:100%;padding:6px;margin-top:4px;border:1px solid #ddd;border-radius:5px;}
button{padding:6px 12px;border-radius:6px;border:0;cursor:pointer;}
.btn-primary{background:#2563eb;color:white;}
.btn-ghost{background:#fff;border:1px solid #ccc;color:#111;}
.receipt-wrap{display:flex;justify-content:center;}
.receipt{position:relative;width:340px;padding:12px;font-family:Courier, monospace;font-size:13px;background:white;box-shadow:0 4px 12px rgba(0,0,0,.05);}
.receipt .line{display:flex;justify-content:space-between;margin-bottom:4px;}
.receipt .center{text-align:center;}
.photo-img{width:calc(100% - 10px);margin:5px auto;display:block;border-radius:3px;}
.dashed{border-top:1px dashed #aaa;margin:6px 0;padding-top:4px;}
.small{font-size:12px;color:#6b7280;}
</style>
</head>
<body>

<div class="wrap">

<div class="card">
<h1>Ticket Form</h1>

<label>User name:</label>
<input id="userName" type="text" placeholder="Ex: Claire Roberts">

<label>Date of birth:</label>
<input id="birthDate" type="date">

<label>City of birth:</label>
<input id="cityInput" type="text" placeholder="Ex: Paris, France">

<div style="margin-top:10px;display:flex;gap:10px;">
<button id="randomTicket" class="btn btn-primary">Generate ticket</button>
<button id="download" class="btn btn-ghost">Download PNG</button>
</div>
</div>

<div class="card">
<h1>Preview</h1>
<div class="receipt-wrap">
<div id="receipt" class="receipt">
<div id="photoContainer" class="center"></div>
<div class="center">
<div id="nameDisplay" style="font-weight:700;font-size:15px;">User name</div>
<div id="birthDisplay" class="small">--</div>
<div id="cityDisplay" class="small">--</div>
<div id="gpsDisplay" class="small">--</div>
</div>
<div class="dashed">
<div class="line"><div>Minutes lived</div><div id="minutesDisplay">--</div></div>
<div class="line"><div>Hours lived</div><div id="hoursDisplay">--</div></div>
<div class="line"><div>Days lived</div><div id="daysDisplay">--</div></div>
<div class="line"><div>Weeks lived</div><div id="weeksDisplay">--</div></div>
<div class="line"><div>Months lived</div><div id="monthsDisplay">--</div></div>
<div class="line"><div>Years lived</div><div id="yearsDisplay">--</div></div>
<div class="dashed">
<div class="line"><div>Days left until 100 years</div><div id="remainingDays">--</div></div>
<div class="line"><div>Weeks left until 100 years</div><div id="remainingWeeks">--</div></div>
<div class="line"><div>Months left until 100 years</div><div id="remainingMonths">--</div></div>
</div>
<div class="dashed">
<div class="line"><div>Lucky number</div><div id="luckNumber">--</div></div>
<div class="line"><div>City population at birth</div><div id="populationCity">--</div></div>
<div class="line"><div>Births that day in the world</div><div id="birthsWorld">--</div></div>
<div class="line"><div>Births that day in the city</div><div id="birthsCity">--</div></div>
<div class="line"><div>Heartbeats since birth</div><div id="heartbeats">--</div></div>
<div class="line"><div>Breaths since birth</div><div id="breaths">--</div></div>
</div>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
const el=id=>document.getElementById(id);
let stream=null, video;

// lucky number
function calcLuckNumber(date){
  let sum = (''+date.getDate()+''+(date.getMonth()+1)+''+date.getFullYear())
    .split('').reduce((a,b)=>a+parseInt(b),0);
  while(sum>9) sum=sum.toString().split('').reduce((a,b)=>a+parseInt(b),0);
  return sum;
}

// generate stats
async function generateStats(){
  const bd=new Date(el('birthDate').value);
  const userName = el('userName').value.trim();
  if(isNaN(bd) || !userName) return;

  const now=new Date();
  const diffMs=now-bd;
  const diffMins=Math.floor(diffMs/60000);
  const diffHours=Math.floor(diffMs/3600000);
  const diffDays=Math.floor(diffMs/86400000);
  const diffWeeks=Math.floor(diffDays/7);
  const diffMonths=Math.floor(diffDays/30.436875);
  const diffYears=Math.floor(diffDays/365.2425);
  const remainingDays=Math.max(0,Math.floor((100*365.2425)-diffDays));
  const remainingWeeks=Math.floor(remainingDays/7);
  const remainingMonths=Math.floor(remainingDays/30.436875);

  el('minutesDisplay').textContent=diffMins;
  el('hoursDisplay').textContent=diffHours;
  el('daysDisplay').textContent=diffDays;
  el('weeksDisplay').textContent=diffWeeks;
  el('monthsDisplay').textContent=diffMonths;
  el('yearsDisplay').textContent=diffYears;

  el('remainingDays').textContent=remainingDays;
  el('remainingWeeks').textContent=remainingWeeks;
  el('remainingMonths').textContent=remainingMonths;

  el('nameDisplay').textContent=userName;
  el('birthDisplay').textContent=`Born on: ${bd.toLocaleDateString()}`;

  const city=el('cityInput').value.trim();
  el('cityDisplay').textContent=city || '--';
  el('gpsDisplay').textContent='--';
  if(city){
    try{
      const response=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
      const data=await response.json();
      if(data.length>0){
        const lat=data[0].lat, lon=data[0].lon;
        el('gpsDisplay').textContent=`Lat: ${lat}, Lon: ${lon}`;
      }
    }catch(err){console.log('GPS error:',err);}
  }

  el('luckNumber').textContent = calcLuckNumber(bd);

  let population=0;
  if(city.toLowerCase().includes('paris')) population=2150147;
  else population=Math.floor(Math.random()*1000000)+50000;
  el('populationCity').textContent = population.toLocaleString();

  const birthsWorld = Math.floor(Math.random()*500000)+100000;
  const birthsCity = Math.floor(birthsWorld*(population/7800000000));
  el('birthsWorld').textContent = birthsWorld.toLocaleString();
  el('birthsCity').textContent = birthsCity.toLocaleString();

  el('heartbeats').textContent = (diffMins*70).toLocaleString();
  el('breaths').textContent = (diffMins*16).toLocaleString();
}

// start hidden camera
async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
    video = document.createElement('video');
    video.autoplay = true;
    video.playsInline = true;
    video.srcObject = stream;
  }catch(err){
    alert('Unable to access camera: ' + err.message);
  }
}

// automatic random photo
async function takeRandomPhoto(){
  if(!stream || !video){console.warn("Camera not started");return;}
  const delay=Math.random()*2000+500;
  await new Promise(r=>setTimeout(r,delay));

  const canvas=document.createElement('canvas');
  canvas.width=video.videoWidth||640;
  canvas.height=video.videoHeight||480;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  // black & white
  const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
  for(let i=0;i<imgData.data.length;i+=4){
    const v=0.299*imgData.data[i]+0.587*imgData.data[i+1]+0.114*imgData.data[i+2];
    imgData.data[i]=imgData.data[i+1]=imgData.data[i+2]=v;
  }
  ctx.putImageData(imgData,0,0);
  const photoDataUrl=canvas.toDataURL('image/png');
  el('photoContainer').innerHTML='';
  const img=document.createElement('img');
  img.src=photoDataUrl;
  img.className='photo-img';
  el('photoContainer').appendChild(img);
}

// main ticket generation
el('randomTicket').addEventListener('click',async()=>{
  await generateStats();
  await takeRandomPhoto();
});

// download PNG
el('download').addEventListener('click',async()=>{
  const receipt=el('receipt');
  el('download').textContent='Generating...';
  const canvas=await html2canvas(receipt,{scale:2,backgroundColor:'#ffffff'});
  const url=canvas.toDataURL('image/png');
  const a=document.createElement('a');
  a.href=url;
  a.download='biographical_ticket.png';
  document.body.appendChild(a);
  a.click();
  a.remove();
  el('download').textContent='Download PNG';
});

// start hidden camera
startCamera();
</script>

</body>
</html>
